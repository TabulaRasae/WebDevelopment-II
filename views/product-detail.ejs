<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title><%= product.name %> | BMCC UsedBooks Store</title>
    <link href="/styles.css" rel="stylesheet" type="text/css" />
  </head>
  <body>
    <div id="main">
      <%- include('partials/navigation'); %>
      <div id="content" class="content-panel">
        <div class="hh1"><%= product.name %></div>
        <p class="span_cont"><%= product.headline %></p>
        <% if (typeof message !== "undefined" && message) { %>
        <div class="message-banner <%= isError ? 'error' : '' %>">
          <%= message %>
        </div>
        <% } %>
        <div class="detail-layout">
          <div class="detail-hero">
            <div class="product-cover is-detail">
              <img
                src="<%= product.image %>"
                class="book-image"
                alt="<%= product.name %>"
              />
            </div>
          </div>
          <div class="detail-body">
            <p class="size"><%= product.description %></p>
            <ul class="spec-list">
              <% product.specs.forEach(function(spec){ %>
              <li><%= spec %></li>
              <% }) %>
            </ul>
            <form action="/cart/add" method="post" class="detail-cart">
              <input type="hidden" name="productId" value="<%= product.id %>" />
              <input
                type="hidden"
                name="redirect"
                value="/products/<%= product.id %>"
              />
              <label
                >Quantity
                <input type="number" name="quantity" min="1" value="1" />
              </label>
              <button type="submit" class="submit">
                Add to Cart - $<%= product.price.toFixed(2) %>
              </button>
            </form>
            <% if (isOwner || isAdmin) { %>
            <div class="edit-card">
              <div class="edit-header">
                <div>
                  <div class="title">Edit listing</div>
                  <p class="size">Update details for this book.</p>
                </div>
                <button type="button" class="submit ghost" id="editToggle">
                  Edit
                </button>
              </div>
              <form
                id="editForm"
                class="edit-form"
                action="/products/<%= product.id %>/update"
                method="post"
              >
                <div class="form-grid">
                  <label>
                    Title
                    <input type="text" name="name" value="<%= product.name %>" required />
                  </label>
                  <label>
                    Price (USD)
                    <input
                      type="number"
                      name="price"
                      min="0.01"
                      step="0.01"
                      value="<%= product.price %>"
                      required
                    />
                  </label>
                  <label>
                    Headline
                    <input
                      type="text"
                      name="headline"
                      maxlength="140"
                      value="<%= product.headline %>"
                      required
                    />
                  </label>
                  <label class="wide">
                    Short description
                    <textarea
                      name="shortDescription"
                      rows="2"
                      maxlength="180"
                      required
                    ><%= product.shortDescription %></textarea>
                  </label>
                  <label class="wide">
                    Full description
                    <textarea name="description" rows="3" required><%= product.description %></textarea>
                  </label>
                  <label class="wide">
                    Specs (one per line)
                    <textarea name="specs" rows="3"><%= product.specs.join('\\n') %></textarea>
                  </label>
                  <label class="wide">
                    Image URL
                    <input
                      type="url"
                      name="image"
                      value="<%= product.image %>"
                      required
                    />
                  </label>
                </div>
                <div class="edit-actions">
                  <button type="submit" class="submit">Save changes</button>
                  <button type="button" class="link-button" id="cancelEdit">
                    cancel
                  </button>
                </div>
              </form>
            </div>
            <% } %>
          </div>
        </div>
        <div class="detail-footer">
          <a class="read" href="/products">back to products</a>
          <% if (isOwner || isAdmin) { %>
          <form
            action="/products/<%= product.id %>/delete"
            method="post"
            onsubmit="return confirm('Delete this listing?');"
          >
            <button type="submit" class="link-button danger">delete listing</button>
          </form>
          <% } %>
        </div>
      </div>
      <%- include('partials/footer'); %>
    </div>
    <% if (isOwner || isAdmin) { %>
    <script>
      (function () {
        const toggle = document.getElementById("editToggle");
        const form = document.getElementById("editForm");
        const cancel = document.getElementById("cancelEdit");
        if (!toggle || !form) return;

        const show = () => {
          form.classList.add("open");
          toggle.setAttribute("disabled", "disabled");
        };
        const hide = () => {
          form.classList.remove("open");
          toggle.removeAttribute("disabled");
        };

        toggle.addEventListener("click", show);
        if (cancel) cancel.addEventListener("click", hide);

        const hasMessage = document.querySelector(".message-banner");
        if (hasMessage && hasMessage.classList.contains("error")) {
          show();
        }
      })();
    </script>
    <% } %>
  </body>
</html>
